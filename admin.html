<!doctype html>
<html lang="pt-BR">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Painel Operador - Biblioteca Online</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{background:#eef2ff}</style>
</head>
<body>
<div class="container py-4">
  <div class="card p-3">
    <h4>Painel do Operador</h4>
    <div id="authArea">
      <div class="mb-2"><input id="email" class="form-control" placeholder="E-mail do operador"></div>
      <div class="mb-2"><input id="password" type="password" class="form-control" placeholder="Senha"></div>
      <div><button id="loginBtn" class="btn btn-primary">Entrar</button></div>
      <div id="authMsg" class="mt-2"></div>
    </div>

    <div id="panel" style="display:none;">
      <div class="mb-3">
        <button class="btn btn-success" id="btnShowAddBook">Cadastrar Livro</button>
        <button class="btn btn-warning" id="btnShowAddStudent">Cadastrar Aluno</button>
        <button class="btn btn-info" id="btnUploadList">Subir Lista (XLSX/CSV/PDF)</button>
        <button class="btn btn-secondary" id="logoutBtn">Sair</button>
      </div>

      <div class="mb-3">
        <h6>Pesquisar no banco (livros)</h6>
        <div class="input-group">
          <input id="search_db_q" class="form-control" placeholder="Pesquisar por título, autor ou Nº Tombo">
          <button id="search_db_btn" class="btn btn-outline-primary">Pesquisar</button>
        </div>
        <div id="search_db_results" class="mt-2"></div>
      </div>

      <div id="areaForms"></div>
      <div id="opMsg" class="mt-2"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="js/config.js"></script>
<script>
let token = null;

document.getElementById('loginBtn').onclick = async ()=>{
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const authMsg = document.getElementById('authMsg');
  authMsg.innerText = 'Entrando...';
  try{
    const res = await axios.post(BACKEND_BASE + 'login.php', {email,password});
    token = res.data.token;
    authMsg.innerText = 'Logado: ' + res.data.nome;
    document.getElementById('authArea').style.display='none';
    document.getElementById('panel').style.display='block';
  }catch(err){
    authMsg.innerText = 'Erro: ' + (err.response?.data?.error || err.message);
  }
};

document.getElementById('logoutBtn').onclick = async ()=>{ token = null; document.getElementById('authArea').style.display=''; document.getElementById('panel').style.display='none'; };

document.getElementById('btnShowAddBook').onclick = ()=>{
  document.getElementById('areaForms').innerHTML = `
    <h5>Cadastrar Livro</h5>
    <div class="row g-2">
      <div class="col-md-3"><input id="num_tombo" class="form-control" placeholder="Nº de Tombo"></div>
      <div class="col-md-5"><input id="nome_livro" class="form-control" placeholder="Nome do livro"></div>
      <div class="col-md-4"><input id="autor" class="form-control" placeholder="Autor"></div>
      <div class="col-md-3 mt-2"><input id="estante" class="form-control" placeholder="Estante"></div>
      <div class="col-md-3 mt-2"><input id="prateleira" class="form-control" placeholder="Prateleira"></div>
      <div class="col-md-2 mt-2"><input id="quant" class="form-control" placeholder="Quant"></div>
      <div class="col-md-4 mt-2"><input id="categoria" class="form-control" placeholder="Categoria"></div>
      <div class="col-md-4 mt-2"><input id="editora" class="form-control" placeholder="Editora"></div>
      <div class="col-md-3 mt-2"><input id="num_destombo" class="form-control" placeholder="Nº de Destombo"></div>
      <div class="col-12 mt-2"><button id="saveBook" class="btn btn-primary">Salvar</button></div>
      <hr class="mt-3 mb-2"/>
      <h6>Ou buscar por ISBN</h6>
      <div class="input-group mt-2">
        <input id="isbn_in" class="form-control" placeholder="Digite o ISBN (ex: 9780140328721)">
        <button id="isbn_btn" class="btn btn-outline-secondary">Buscar ISBN</button>
      </div>
      <div id="isbn_msg" class="mt-2"></div>
    </div>
  `;
  document.getElementById('saveBook').onclick = saveBook;
  document.getElementById('isbn_btn').onclick = buscarISBN;
};

async function buscarISBN(){
  const isbn = document.getElementById('isbn_in').value.trim();
  if(!isbn){ document.getElementById('isbn_msg').innerText='Informe um ISBN'; return; }
  document.getElementById('isbn_msg').innerText = 'Buscando...';
  try{
    const res = await axios.get(BACKEND_BASE + 'isbn_lookup.php?isbn=' + encodeURIComponent(isbn));
    const data = res.data;
    if(data.error){ document.getElementById('isbn_msg').innerText = 'Erro: ' + data.error; return; }
    // Preencher campos do formulário
    document.getElementById('nome_livro').value = data.title || '';
    document.getElementById('autor').value = (data.authors && data.authors.join(', ')) || '';
    document.getElementById('editora').value = (data.publishers && data.publishers.join(', ')) || '';
    document.getElementById('isbn_msg').innerText = 'Dados preenchidos. Revise e clique Salvar.';
  }catch(err){
    document.getElementById('isbn_msg').innerText = 'Erro: ' + (err.response?.data?.error || err.message);
  }
}

async function saveBook(){
  const payload = {
    num_tombo: document.getElementById('num_tombo').value,
    nome_livro: document.getElementById('nome_livro').value,
    autor: document.getElementById('autor').value,
    estante: document.getElementById('estante').value,
    prateleira: document.getElementById('prateleira').value,
    quant: document.getElementById('quant').value,
    categoria: document.getElementById('categoria').value,
    editora: document.getElementById('editora').value,
    num_destombo: document.getElementById('num_destombo').value
  };
  try{
    const res = await axios.post(BACKEND_BASE + 'books.php?action=create', payload, {headers:{Authorization: token}});
    document.getElementById('opMsg').innerText = 'Livro cadastrado!';
  }catch(err){
    document.getElementById('opMsg').innerText = 'Erro: ' + (err.response?.data?.error || err.message);
  }
}

document.getElementById('btnShowAddStudent').onclick = ()=>{
  document.getElementById('areaForms').innerHTML = `
    <h5>Cadastrar Aluno</h5>
    <div class="row g-2">
      <div class="col-md-3"><input id="ra" class="form-control" placeholder="R.A."></div>
      <div class="col-md-6"><input id="nome" class="form-control" placeholder="Nome"></div>
      <div class="col-md-3"><input id="data_nasc" type="date" class="form-control" placeholder="Data de Nascimento"></div>
      <div class="col-md-6 mt-2"><input id="email_student" class="form-control" placeholder="E-mail"></div>
      <div class="col-12 mt-2"><button id="saveStudent" class="btn btn-primary">Salvar</button></div>
    </div>
  `;
  document.getElementById('saveStudent').onclick = saveStudent;
};

async function saveStudent(){
  const payload = {
    ra: document.getElementById('ra').value,
    nome: document.getElementById('nome').value,
    data_nasc: document.getElementById('data_nasc').value,
    email: document.getElementById('email_student').value
  };
  try{
    const res = await axios.post(BACKEND_BASE + 'students.php?action=create', payload, {headers:{Authorization: token}});
    document.getElementById('opMsg').innerText = 'Aluno cadastrado!';
  }catch(err){
    document.getElementById('opMsg').innerText = 'Erro: ' + (err.response?.data?.error || err.message);
  }
}

document.getElementById('btnUploadList').onclick = ()=>{
  document.getElementById('areaForms').innerHTML = `
    <h5>Subir lista (CSV/XLSX/PDF)</h5>
    <input id="fileIn" type="file" class="form-control">
    <div class="mt-2">
      <select id="listType" class="form-select">
        <option value="books">Livros</option>
        <option value="students">Alunos</option>
        <option value="operators">Operadores</option>
      </select>
    </div>
    <div class="mt-2"><button id="doUpload" class="btn btn-primary">Enviar</button></div>
  `;
  document.getElementById('doUpload').onclick = doUpload;
};

async function doUpload(){
  const f = document.getElementById('fileIn').files[0];
  const type = document.getElementById('listType').value;
  if(!f){ alert('Escolha um arquivo'); return; }
  const ext = f.name.split('.').pop().toLowerCase();
  if(ext === 'csv'){
    const txt = await f.text();
    const lines = txt.split(/\r?\n/).filter(Boolean);
    const headers = lines.shift().split(',').map(h=>h.trim());
    const data = lines.map(l=>{ const cols = l.split(','); const obj = {}; headers.forEach((h,i)=> obj[h]=cols[i]??''); return obj; });
    await sendList(data, type);
  } else if(ext==='xlsx' || ext==='xls'){
    const arrayBuffer = await f.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, {type:'array'});
    const first = workbook.SheetNames[0];
    const data = XLSX.utils.sheet_to_json(workbook.Sheets[first], {defval:''});
    await sendList(data, type);
  } else {
    const form = new FormData();
    form.append('file', f);
    form.append('type', type);
    try{
      const res = await axios.post(BACKEND_BASE + 'upload.php', form, {headers:{Authorization: token, 'Content-Type':'multipart/form-data'}});
      document.getElementById('opMsg').innerText = 'Arquivo enviado. ' + (res.data.message || '');
    }catch(err){
      document.getElementById('opMsg').innerText = 'Erro: ' + (err.response?.data?.error || err.message);
    }
  }
}

async function sendList(data, type){
  try{
    const res = await axios.post(BACKEND_BASE + 'upload.php', {type,data}, {headers:{Authorization: token}});
    document.getElementById('opMsg').innerText = 'Lista importada: ' + (res.data.inserted || 0) + ' registros';
  }catch(err){
    document.getElementById('opMsg').innerText = 'Erro: ' + (err.response?.data?.error || err.message);
  }
}

// search DB
document.getElementById('search_db_btn').onclick = async ()=>{
  const q = document.getElementById('search_db_q').value.trim();
  document.getElementById('search_db_results').innerText = 'Carregando...';
  try{
    const res = await axios.get(BACKEND_BASE + 'books.php?action=search&q=' + encodeURIComponent(q));
    const rows = res.data;
    if(!rows.length) document.getElementById('search_db_results').innerHTML = '<div>Nenhum registro</div>';
    else{
      let html = '<div class="list-group">';
      for(const r of rows){
        html += `<div class="list-group-item"><div class="d-flex w-100 justify-content-between"><strong>${r.nome_livro}</strong><small>Nº Tombo: ${r.num_tombo}</small></div><div>Autor: ${r.autor} — Quant: ${r.quant}</div></div>`;
      }
      html += '</div>';
      document.getElementById('search_db_results').innerHTML = html;
    }
  }catch(err){
    document.getElementById('search_db_results').innerText = 'Erro: ' + (err.message || err);
  }
};
</script>
</body>
</html>
